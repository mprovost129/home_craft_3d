{# templates/orders/order_detail.html #}
{% extends "base.html" %}
{% load money %}

{% block title %}Order · Home Craft 3D{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Order</h1>
    <span class="badge text-bg-secondary">{{ order.get_status_display }}</span>
  </div>

  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-3">
        <div class="col-md-6">
          <div class="text-muted small">Order ID</div>
          <div class="fw-semibold">{{ order.id }}</div>
        </div>
        <div class="col-md-6">
          <div class="text-muted small">Total</div>
          <div class="fw-semibold">${{ order.total_cents|cents_to_dollars }}</div>
        </div>
      </div>

      {% if order.is_guest %}
        <div class="alert alert-info mt-3 mb-0">
          <div class="small">
            Guest order. Keep this link safe to access your order later.
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="card shadow-sm mb-4">
    <div class="card-header bg-white d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div class="fw-semibold">Items</div>
      {% if can_download and has_digital_assets %}
        <a class="btn btn-sm btn-outline-primary"
           href="{% url 'orders:download_all_assets' order_id=order.id %}{% if order_token %}?t={{ order_token }}{% endif %}">
          <i class="bi bi-download me-1"></i>Download all
        </a>
      {% endif %}
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table mb-0 align-middle">
          <thead>
            <tr>
              <th>Product</th>
              <th class="text-end">Qty</th>
              <th class="text-end">Unit</th>
              <th class="text-end">Line</th>
              <th class="text-end">Downloads</th>
              <th class="text-end">Refund</th>
            </tr>
          </thead>
          <tbody>
            {% for item in order.items.all %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ item.product }}</div>
                  {% if item.is_digital %}
                    <span class="badge text-bg-info">Digital</span>
                  {% else %}
                    <span class="badge text-bg-warning">Physical</span>
                  {% endif %}
                </td>

                <td class="text-end">{{ item.quantity }}</td>
                <td class="text-end">${{ item.unit_price_cents|cents_to_dollars }}</td>
                <td class="text-end">${{ item.line_total_cents|cents_to_dollars }}</td>

                <td class="text-end">
                  {% if can_download and item.is_digital %}
                    {% with assets=item.product.digital_assets.all %}
                      {% if assets %}
                        <div class="d-flex flex-column gap-1 align-items-end">
                          {% for a in assets %}
                            <a
                              class="btn btn-sm btn-outline-primary"
                              href="{% url 'orders:download_asset' order_id=order.id asset_id=a.id %}{% if order_token %}?t={{ order_token }}{% endif %}"
                            >
                              Download{% if a.original_filename %}: {{ a.original_filename }}{% endif %}
                            </a>
                          {% endfor %}
                        </div>
                      {% else %}
                        <span class="text-muted small">No files.</span>
                      {% endif %}
                    {% endwith %}
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  {# Refunds: physical-only line items on PAID orders. One request per item (OneToOne). #}
                  {% if order.status == order.Status.PAID and not item.is_digital and item.requires_shipping %}
                    {% if item.refund_request %}
                      <a
                        class="btn btn-sm btn-outline-secondary"
                        href="{% url 'refunds:buyer_detail' refund_id=item.refund_request.pk %}{% if order_token %}?t={{ order_token }}{% endif %}"
                        title="View refund request"
                      >
                        View request
                      </a>
                    {% else %}
                      <a
                        class="btn btn-sm btn-outline-danger"
                        href="{% url 'refunds:buyer_create' order_id=order.id item_id=item.id %}{% if order_token %}?t={{ order_token }}{% endif %}"
                      >
                        Request refund
                      </a>
                    {% endif %}
                  {% else %}
                    <span class="text-muted small">—</span>
                  {% endif %}
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">No items.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  {% if order.requires_shipping %}
    <div class="card shadow-sm">
      <div class="card-header bg-white">
        <div class="fw-semibold">Shipping</div>
      </div>
      <div class="card-body">
        <div class="small text-muted">Ship to</div>
        <div class="fw-semibold">{{ order.shipping_name }}</div>
        <div>{{ order.shipping_line1 }}{% if order.shipping_line2 %}, {{ order.shipping_line2 }}{% endif %}</div>
        <div>{{ order.shipping_city }}, {{ order.shipping_state }} {{ order.shipping_postal_code }}</div>
      </div>
    </div>
  {% endif %}

  {% if order.status == order.Status.PAID and request.user.is_authenticated %}
    <div class="card shadow-sm mt-4">
      <div class="card-header bg-white">
        <div class="fw-semibold">Rate Sellers</div>
      </div>
      <div class="card-body">
        <div class="text-muted small mb-3">Share your feedback about the sellers you purchased from.</div>
        {% regroup order.items.all by seller as sellers_list %}
        {% for seller_group in sellers_list %}
          <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
            <div>
              <div class="fw-semibold">{{ seller_group.grouper.username }}</div>
              <div class="small text-muted">{{ seller_group.list|length }} item{{ seller_group.list|pluralize }}</div>
            </div>
            <a
              class="btn btn-sm btn-outline-primary"
              href="{% url 'reviews:seller_review_new' order.id seller_group.grouper.id %}"
            >
              {% if order.seller_reviews|length > 0 %}
                View rating
              {% else %}
                Rate seller
              {% endif %}
            </a>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
