{% extends "base.html" %}
{% block title %}Seller Order #{{ order.id }} · Home Craft 3D{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
    <div>
      <h1 class="h4 mb-1">Order #{{ order.id }}</h1>
      <div class="text-secondary small">
        Status: <span class="fw-semibold">{{ order.get_status_display }}</span>
        · Your total: <span class="fw-semibold">${{ seller_total|floatformat:2 }}</span>
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-dark" href="{% url 'orders:seller_orders_list' %}">
        <i class="bi bi-arrow-left me-1"></i>Back to orders
      </a>
    </div>
  </div>

  {% if order.status != "PAID" %}
    <div class="alert alert-warning">
      This order is not paid yet. Shipping actions are disabled until payment is complete.
    </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Your items in this order</div>
        </div>
        <div class="card-body">
          {% if items %}
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Kind</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Line total</th>
                    <th>Fulfillment</th>
                  </tr>
                </thead>
                <tbody>
                  {% for it in items %}
                    <tr>
                      <td class="fw-semibold">
                        <a class="text-decoration-none" href="{% url 'products:detail' pk=it.product_id slug=it.product.slug %}">{{ it.title }}</a>
                        {% if it.tracking_number %}
                          <div class="text-secondary small">Tracking: <span class="font-monospace">{{ it.tracking_number }}</span></div>
                        {% endif %}
                        {% if it.buyer_notes %}
                          <div class="alert alert-info alert-sm mt-2 mb-0 p-2">
                            <div class="small fw-semibold">
                              <i class="bi bi-chat-left-text me-1"></i>Buyer's Special Instructions:
                            </div>
                            <div class="small" style="white-space: pre-wrap;">{{ it.buyer_notes }}</div>
                          </div>
                        {% endif %}
                      </td>
                      <td>
                        {% if it.kind == "MODEL" %}
                          <span class="badge text-bg-secondary">Physical</span>
                        {% else %}
                          <span class="badge text-bg-info">Digital</span>
                        {% endif %}
                      </td>
                      <td class="text-end">{{ it.quantity }}</td>
                      <td class="text-end"><strong>${{ it.line_total|floatformat:2 }}</strong></td>
                      <td>
                        {% if it.is_digital %}
                          <span class="badge text-bg-success">Delivered</span>
                          <div class="text-secondary small">Downloads handled automatically.</div>
                        {% else %}
                          {% if it.fulfillment_status == "SHIPPED" %}
                            <span class="badge text-bg-success">Shipped</span>
                            {% if it.shipped_at %}
                              <div class="text-secondary small">{{ it.shipped_at|date:"M j, Y" }}</div>
                            {% endif %}
                          {% else %}
                            <span class="badge text-bg-warning text-dark">Unfulfilled</span>

                            {% if order.status == "PAID" %}
                              <form class="mt-2" method="post" action="{% url 'orders:seller_item_mark_shipped' it.id %}">
                                {% csrf_token %}
                                <div class="row g-2">
                                  <div class="col-md-5">
                                    <input class="form-control form-control-sm" name="carrier" placeholder="Carrier (UPS/USPS/FedEx)" />
                                  </div>
                                  <div class="col-md-7">
                                    <input class="form-control form-control-sm" name="tracking_number" placeholder="Tracking number" />
                                  </div>
                                </div>
                                <div class="mt-2">
                                  <button class="btn btn-sm btn-dark" type="submit">
                                    <i class="bi bi-truck me-1"></i>Mark shipped
                                  </button>
                                </div>
                              </form>
                            {% endif %}
                          {% endif %}
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="text-secondary">No items for you in this order.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card mb-3">
        <div class="card-header"><div class="fw-semibold">Buyer & Shipping</div></div>
        <div class="card-body">
          <div class="mb-2">
            <div class="text-secondary small">Buyer</div>
            <div class="fw-semibold">
              {% if order.buyer %}{{ order.buyer.username }}{% else %}Guest{% endif %}
            </div>
          </div>

          <div>
            <div class="text-secondary small">Ship to</div>
            {% if order.ship_line1 or order.ship_city or order.ship_postal_code %}
              <div class="small">
                <div class="fw-semibold">{{ order.ship_name }}</div>
                <div>{{ order.ship_line1 }}</div>
                {% if order.ship_line2 %}<div>{{ order.ship_line2 }}</div>{% endif %}
                <div>{{ order.ship_city }}, {{ order.ship_state }} {{ order.ship_postal_code }}</div>
                <div>{{ order.ship_country }}</div>
                {% if order.ship_phone %}<div class="mt-1">Phone: {{ order.ship_phone }}</div>{% endif %}
              </div>
            {% else %}
              <div class="text-secondary small">No shipping address recorded.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header"><div class="fw-semibold">Order snapshot</div></div>
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div class="text-secondary">Created</div>
            <div class="fw-semibold">{{ order.created_at|date:"M j, Y" }}</div>
          </div>
          {% if order.paid_at %}
          <div class="d-flex justify-content-between">
            <div class="text-secondary">Paid</div>
            <div class="fw-semibold">{{ order.paid_at|date:"M j, Y" }}</div>
          </div>
          {% endif %}
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}