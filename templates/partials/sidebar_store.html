{# templates/partials/sidebar_store.html #}
{% load static %}

<div class="p-3 hc3-sidebar">

  <div class="text-uppercase small text-secondary fw-semibold mb-2">
    <i class="bi bi-compass me-1"></i>Explore
  </div>

  <ul class="list-unstyled mb-3">
    <li class="mb-1">
      <a class="hc3-side-link" href="{% url 'products:list' %}">
        <i class="bi bi-grid"></i>
        <span>All Products</span>
      </a>
    </li>
    <li class="mb-1">
      <a class="hc3-side-link" href="{% url 'products:list' %}?sort=trending">
        <i class="bi bi-fire"></i>
        <span>Trending</span>
      </a>
    </li>
    <li class="mb-1">
      <a class="hc3-side-link" href="{% url 'products:list' %}?sort=top">
        <i class="bi bi-star"></i>
        <span>Top Rated</span>
      </a>
    </li>
    <li class="mb-1">
      <a class="hc3-side-link" href="{% url 'products:list' %}?sort=new">
        <i class="bi bi-clock"></i>
        <span>New Arrivals</span>
      </a>
    </li>
  </ul>

  {# Only the filter/search is collapsible, categories always show #}
  <details class="mb-3">
    <summary class="small text-secondary fw-semibold">Filters</summary>
    <form class="mt-2 d-grid gap-2" method="get" action="{% if request.path|slice:':9' == '/products' %}{{ request.path }}{% else %}{% url 'products:list' %}{% endif %}">
      <input class="form-control form-control-sm" name="q" value="{{ request.GET.q }}" placeholder="Search...">
      <div class="input-group input-group-sm mb-2">
        <span class="input-group-text"><i class="bi bi-funnel"></i></span>
        <input id="hc3SidebarFilter"
               class="form-control"
               type="search"
               placeholder="Filter categories…"
               aria-label="Filter categories">
        <button class="btn btn-outline-secondary" type="button" id="hc3SidebarFilterClear" title="Clear">
          <i class="bi bi-x-lg"></i>
        </button>
      </div>

      {% if request.path|slice:':15' == '/products/models' %}
        <input type="hidden" name="kind" value="MODEL">
      {% elif request.path|slice:':14' == '/products/files' %}
        <input type="hidden" name="kind" value="FILE">
      {% else %}
        <select class="form-select form-select-sm" name="kind">
          <option value="">All</option>
          <option value="MODEL" {% if request.GET.kind == 'MODEL' %}selected{% endif %}>3D Models</option>
          <option value="FILE" {% if request.GET.kind == 'FILE' %}selected{% endif %}>3D Files</option>
        </select>

      {% endif %}

      {% if request.path|slice:':15' != '/products/models' %}
        <select class="form-select form-select-sm" name="file_type">
          <option value="">All file types</option>
          {% for t in sidebar_file_type_options %}
            <option value="{{ t }}" {% if request.GET.file_type == t %}selected{% endif %}>.{{ t }}</option>
          {% endfor %}
        </select>
      {% endif %}

      <div class="d-flex gap-2">
        <input type="number" class="form-control form-control-sm" name="price_min" value="{{ request.GET.price_min }}" placeholder="Min price">
        <input type="number" class="form-control form-control-sm" name="price_max" value="{{ request.GET.price_max }}" placeholder="Max price">
      </div>

      <select class="form-select form-select-sm" name="complexity">
        <option value="">All levels</option>
        {% for value, label in sidebar_complexity_options %}
          <option value="{{ value }}" {% if request.GET.complexity == value %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>

      {% if request.path|slice:':15' != '/products/models' %}
        <select class="form-select form-select-sm" name="license_type">
          <option value="">All licenses</option>
          {% for value, label in sidebar_license_type_options %}
            <option value="{{ value }}" {% if request.GET.license_type == value %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>

        <label class="small d-flex align-items-center gap-2">
          <input type="checkbox" name="instant" value="1" {% if request.GET.instant == '1' %}checked{% endif %}>
          Instant download only
        </label>
      {% endif %}

      <select class="form-select form-select-sm" name="rating_min">
        <option value="">All ratings</option>
        <option value="4" {% if request.GET.rating_min == '4' %}selected{% endif %}>4★ & up</option>
        <option value="3" {% if request.GET.rating_min == '3' %}selected{% endif %}>3★ & up</option>
        <option value="2" {% if request.GET.rating_min == '2' %}selected{% endif %}>2★ & up</option>
        <option value="1" {% if request.GET.rating_min == '1' %}selected{% endif %}>1★ & up</option>
      </select>

      <select class="form-select form-select-sm" name="sort">
        <option value="new" {% if request.GET.sort == 'new' or not request.GET.sort %}selected{% endif %}>Sort: New</option>
        <option value="trending" {% if request.GET.sort == 'trending' %}selected{% endif %}>Sort: Trending</option>
        <option value="top" {% if request.GET.sort == 'top' %}selected{% endif %}>Sort: Top Rated</option>
      </select>

      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-dark" type="submit">Apply</button>
        {% if request.path|slice:':15' == '/products/models' %}
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'products:models' %}">Clear</a>
        {% elif request.path|slice:':14' == '/products/files' %}
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'products:files' %}">Clear</a>
        {% else %}
          <a class="btn btn-sm btn-outline-secondary" href="{% url 'products:list' %}">Clear</a>
        {% endif %}
      </div>
    </form>
  </details>

  {# -------------------- 3D MODELS -------------------- #}
  <div class="text-uppercase small text-secondary fw-semibold mb-2">
    <i class="bi bi-box-seam me-1"></i>3D Models
  </div>

  <ul class="list-unstyled mb-3" id="hc3ModelsList">
    {% for cat in sidebar_model_categories %}
      {% if forloop.counter0 == 8 %}
        </ul>

        <details class="hc3-more mb-3" id="hc3ModelsMore">
          <summary class="hc3-more-summary">More…</summary>
          <ul class="list-unstyled mt-2" id="hc3ModelsMoreList">
      {% endif %}

      <li class="mb-1 hc3-filter-parent" data-name="{{ cat.name|lower }}">
        <div class="hc3-cat-row">
          <a class="hc3-cat-link" href="{{ cat.get_absolute_url }}">{{ cat.name }}</a>

          {% if cat.children.all|length %}
            <button class="btn btn-sm hc3-tree-toggle hc3-cat-toggle"
                    type="button"
                    data-target="cat-{{ cat.id }}"
                    aria-expanded="false"
                    aria-controls="cat-{{ cat.id }}"
                    title="Show subcategories">
              <i class="bi bi-caret-right-fill"></i>
            </button>
          {% endif %}
        </div>

        {% if cat.children.all|length %}
          <ul class="list-unstyled ms-2 mt-1 hc3-tree-children"
              id="cat-{{ cat.id }}"
              hidden>
            {% for child in cat.children.all %}
              <li class="mb-1 hc3-filter-child" data-name="{{ child.name|lower }}">
                <a class="hc3-child-link" href="{{ child.get_absolute_url }}">
                  {{ child.name }}
                </a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </li>
    {% empty %}
      <li class="text-secondary small">No model categories yet.</li>
    {% endfor %}
  </ul>

  {% if sidebar_model_categories|length > 8 %}
        </ul>
      </details>
  {% endif %}

  {# -------------------- 3D FILES -------------------- #}
  <div class="text-uppercase small text-secondary fw-semibold mb-2">
    <i class="bi bi-file-earmark-zip me-1"></i>3D Files
  </div>

  <ul class="list-unstyled mb-0" id="hc3FilesList">
    {% for cat in sidebar_file_categories %}
      {% if forloop.counter0 == 8 %}
        </ul>

        <details class="hc3-more mb-0" id="hc3FilesMore">
          <summary class="hc3-more-summary">More…</summary>
          <ul class="list-unstyled mt-2" id="hc3FilesMoreList">
      {% endif %}

      <li class="mb-1 hc3-filter-parent" data-name="{{ cat.name|lower }}">
        <div class="hc3-cat-row">
          <a class="hc3-cat-link" href="{{ cat.get_absolute_url }}">{{ cat.name }}</a>

          {% if cat.children.all|length %}
            <button class="btn btn-sm hc3-tree-toggle hc3-cat-toggle"
                    type="button"
                    data-target="cat-{{ cat.id }}"
                    aria-expanded="false"
                    aria-controls="cat-{{ cat.id }}"
                    title="Show subcategories">
              <i class="bi bi-caret-right-fill"></i>
            </button>
          {% endif %}
        </div>

        {% if cat.children.all|length %}
          <ul class="list-unstyled ms-2 mt-1 hc3-tree-children"
              id="cat-{{ cat.id }}"
              hidden>
            {% for child in cat.children.all %}
              <li class="mb-1 hc3-filter-child" data-name="{{ child.name|lower }}">
                <a class="hc3-child-link" href="{{ child.get_absolute_url }}">
                  {{ child.name }}
                </a>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      </li>
    {% empty %}
      <li class="text-secondary small">No file categories yet.</li>
    {% endfor %}
  </ul>

  {% if sidebar_file_categories|length > 8 %}
        </ul>
      </details>
  {% endif %}

</div>