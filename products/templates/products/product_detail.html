{% extends "base.html" %}
{% block title %}{{ product.title }} · Home Craft 3D{% endblock %}
{% block meta_title %}{{ product.title }} · Home Craft 3D{% endblock %}
{% block meta_description %}
  {% if product.short_description %}
    {{ product.short_description }}
  {% elif product.description %}
    {{ product.description|striptags|truncatechars:160 }}
  {% else %}
    Explore this product on Home Craft 3D.
  {% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row g-3">
    <div class="col-12 col-lg-7">
      <div class="card">
        {% if product.images.all %}
          <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
              {% for img in product.images.all %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                  <img src="{{ img.image.url }}" class="d-block w-100" alt="{{ img.alt_text|default:product.title }}">
                </div>
              {% endfor %}
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
              <span class="carousel-control-next-icon" aria-hidden="true"></span>
              <span class="visually-hidden">Next</span>
            </button>
          </div>

          {% if product.images.all|length > 1 %}
          <div class="card-body pt-2 pb-2">
            <div class="d-flex gap-2 flex-wrap">
              {% for img in product.images.all %}
                <button 
                  type="button" 
                  class="border rounded p-1 bg-white thumbnail-btn {% if forloop.first %}active{% endif %}" 
                  data-bs-target="#productCarousel" 
                  data-bs-slide-to="{{ forloop.counter0 }}"
                  style="width: 70px; height: 70px; cursor: pointer; opacity: {% if forloop.first %}1{% else %}0.6{% endif %};"
                  onclick="this.parentElement.querySelectorAll('.thumbnail-btn').forEach(b => b.style.opacity='0.6'); this.style.opacity='1';"
                >
                  <img src="{{ img.image.url }}" class="w-100 h-100 rounded" style="object-fit: cover;" alt="{{ img.alt_text|default:product.title }}">
                </button>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        {% else %}
          <div class="bg-light d-flex align-items-center justify-content-center" style="height:360px;">
            <span class="text-secondary small">No images uploaded yet.</span>
          </div>
        {% endif %}
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start gap-2">
            <div>
              <h1 class="h4 mb-1">{{ product.title }}</h1>
              <div class="text-secondary small">
                by <strong>{{ product.seller_public_name }}</strong> · {{ product.category.name }}
              </div>

              <div class="mt-1 small">
                {% if review_count and review_count > 0 %}
                  <span class="badge text-bg-dark me-1">{{ avg_rating|floatformat:1 }}/5</span>
                  <span class="text-secondary">{{ review_count }} review{{ review_count|pluralize }}</span>
                  <a class="ms-2 text-decoration-none" href="{% url 'reviews:product_reviews' product.id %}">View reviews</a>
                {% else %}
                  <span class="text-secondary">No product reviews yet.</span>
                {% endif %}
              </div>

              <div class="mt-1 small">
                {% if seller_review_count and seller_review_count > 0 %}
                  <span class="badge text-bg-secondary me-1">Seller {{ seller_avg_rating|floatformat:1 }}/5</span>
                  <span class="text-secondary">{{ seller_review_count }} seller rating{{ seller_review_count|pluralize }}</span>
                {% else %}
                  <span class="text-secondary">Seller has no ratings yet.</span>
                {% endif %}
              </div>
            </div>
            <span class="badge text-bg-secondary">{{ product.get_kind_display }}</span>
          </div>

          {% if product.complexity_level or product.print_time_hours %}
            <div class="mt-2 d-flex flex-wrap gap-2">
              {% if product.complexity_level %}
                <span class="badge text-bg-secondary">{{ product.get_complexity_level_display }}</span>
              {% endif %}
              {% if product.print_time_hours %}
                <span class="badge text-bg-secondary">
                  <i class="bi bi-clock me-1"></i>{{ product.print_time_hours }}h print time
                </span>
              {% endif %}
            </div>
          {% endif %}

          <div class="mt-3">
            <div class="h5 mb-2">{{ product.display_price }}</div>

            {% if can_buy %}
              <form method="post" action="{% url 'cart:add' %}">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.pk }}">

                {% if product.kind == "MODEL" %}
                  <div class="d-flex gap-2">
                    <input class="form-control" type="number" name="quantity" min="1" value="1" style="max-width:120px;">
                    <button class="btn btn-dark flex-grow-1" type="submit">
                      <i class="bi bi-cart-plus me-1"></i>Add to cart
                    </button>
                  </div>
                {% else %}
                  <input type="hidden" name="quantity" value="1">
                  <button class="btn btn-dark w-100" type="submit">
                    <i class="bi bi-cart-plus me-1"></i>Add to cart
                  </button>
                  <div class="text-secondary small mt-2">Digital items are limited to 1 per cart.</div>
                {% endif %}
              </form>
            {% else %}
              <button class="btn btn-dark w-100" type="button" disabled style="opacity:.6; cursor:not-allowed;">
                <i class="bi bi-cart-plus me-1"></i>Add to cart
              </button>
              <div class="small mt-2" style="color:#b45309;">Seller not ready (Stripe onboarding incomplete).</div>
            {% endif %}

            <div class="mt-2">
              <a class="btn btn-outline-dark w-100" href="{% url 'cart:detail' %}">
                <i class="bi bi-bag me-1"></i>View cart
              </a>
            </div>
          </div>

          {% if product.short_description %}
            <hr>
            <div class="text-secondary">{{ product.short_description }}</div>
          {% endif %}

          {% if product.description %}
            <hr>
            <div style="white-space: pre-wrap;">{{ product.description }}</div>
          {% endif %}

          {% if product.kind == "FILE" %}
            <hr>
            <div class="fw-semibold mb-1">Files included</div>
            {% if product.digital_assets.all %}
              <ul class="small text-secondary mb-0">
                {% for a in product.digital_assets.all %}
                  <li>
                    {{ a.original_filename|default:a.file.name }}
                    {% if a.file_type %}<span class="text-muted">(.{{ a.file_type }})</span>{% endif %}
                    {% if a.file_type == "zip" and a.zip_contents %}
                      <div class="mt-1">
                        <div class="text-muted">Includes:</div>
                        <ul class="mb-2">
                          {% for item in a.zip_contents|slice:":12" %}
                            <li>{{ item }}</li>
                          {% endfor %}
                          {% if a.zip_contents|length > 12 %}
                            <li>+ {{ a.zip_contents|length|add:"-12" }} more…</li>
                          {% endif %}
                        </ul>
                      </div>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <div class="text-secondary small">No files uploaded yet.</div>
            {% endif %}
          {% endif %}

          <hr>

          <!-- Tabs: Q&A + Reviews -->
          <ul class="nav nav-tabs" id="productTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="qa-tab" data-bs-toggle="tab" data-bs-target="#qa-pane" type="button" role="tab" aria-controls="qa-pane" aria-selected="true">
                Q&amp;A <span class="badge text-bg-light text-dark ms-1">{{ qa_thread_count }}</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews-pane" type="button" role="tab" aria-controls="reviews-pane" aria-selected="false">
                Reviews <span class="badge text-bg-light text-dark ms-1">{{ review_count }}</span>
              </button>
            </li>
          </ul>

          <div class="tab-content pt-3" id="productTabsContent">
            <div class="tab-pane fade show active" id="qa-pane" role="tabpanel" aria-labelledby="qa-tab" tabindex="0">
              {% include "qa/_products_tab.html" %}
            </div>

            <div class="tab-pane fade" id="reviews-pane" role="tabpanel" aria-labelledby="reviews-tab" tabindex="0">
              <div class="d-flex align-items-center justify-content-between">
                <div class="fw-semibold">Recent reviews</div>
                <a class="text-decoration-none" href="{% url 'reviews:product_reviews' product.id %}">All reviews</a>
              </div>

              <div class="mt-2">
                {% for r in recent_reviews %}
                  <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                      <div class="small fw-semibold">{{ r.buyer.username }}</div>
                      <div class="small text-secondary">{{ r.created_at|date:"M j, Y" }}</div>
                    </div>
                    <div class="mt-1">
                      <span class="badge text-bg-dark">{{ r.rating }}/5</span>
                      {% if r.title %}
                        <span class="ms-2 fw-semibold">{{ r.title }}</span>
                      {% endif %}
                    </div>
                    {% if r.body %}
                      <div class="small mt-2">{{ r.body|linebreaksbr }}</div>
                    {% endif %}
                  </div>
                {% empty %}
                  <div class="text-secondary small">No reviews yet.</div>
                {% endfor %}
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}